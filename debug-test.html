<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ—¶é—´æˆ³æ‰©å±•è°ƒè¯•å·¥å…·</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 40px;
      background: #f5f5f5;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
    }
    h1 {
      color: #1e293b;
      margin-top: 0;
    }
    .test-element {
      margin: 20px 0;
      padding: 15px;
      border: 2px solid #667eea;
      border-radius: 8px;
      background: #f8f9ff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    td {
      padding: 12px;
      border: 1px solid #ddd;
    }
    .dbsv5-table-cell {
      background: #fafafa;
    }
    .dbsv5-table-cell-ellipsis {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .debug-info {
      background: #f0f0f0;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-family: monospace;
      font-size: 13px;
    }
    .success {
      color: #22c55e;
      font-weight: bold;
    }
    .error {
      color: #ef4444;
      font-weight: bold;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover {
      opacity: 0.9;
    }
    .info-box {
      background: #dbeafe;
      border-left: 4px solid #3b82f6;
      padding: 15px;
      margin: 15px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” æ—¶é—´æˆ³æ‰©å±•è°ƒè¯•å·¥å…·</h1>
    
    <div class="info-box">
      <strong>ä½¿ç”¨æ–¹æ³•ï¼š</strong>
      <ol>
        <li>ç¡®ä¿å·²å®‰è£…æ—¶é—´æˆ³è¯†åˆ«æ‰©å±•</li>
        <li>åŒå‡»ä¸‹é¢çš„æ—¶é—´æˆ³å…ƒç´ </li>
        <li>æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯äº†è§£å‘ç”Ÿäº†ä»€ä¹ˆ</li>
      </ol>
    </div>

    <h2>æµ‹è¯•å…ƒç´ ï¼ˆä½ çš„å®é™…åœºæ™¯ï¼‰</h2>
    <div class="test-element">
      <table>
        <tr>
          <td class="dbsv5-table-cell dbsv5-table-cell-ellipsis">
            <div style="white-space: pre;">1758511800732</div>
          </td>
          <td>2025-10-23 03:36:40.732</td>
        </tr>
      </table>
    </div>

    <h2>è°ƒè¯•ä¿¡æ¯</h2>
    <div id="debug-output" class="debug-info">ç­‰å¾…åŒå‡»æ“ä½œ...</div>

    <h2>æ‰‹åŠ¨æµ‹è¯•å·¥å…·</h2>
    <button onclick="testExtensionLoaded()">æ£€æŸ¥æ‰©å±•æ˜¯å¦åŠ è½½</button>
    <button onclick="testElementText()">æµ‹è¯•å…ƒç´ æ–‡æœ¬æå–</button>
    <button onclick="testSelection()">æµ‹è¯•æ–‡æœ¬é€‰æ‹©</button>
    <button onclick="clearDebug()">æ¸…é™¤è°ƒè¯•ä¿¡æ¯</button>

    <h2>æ—¶é—´æˆ³è½¬æ¢ç»“æœ</h2>
    <div id="conversion-result" class="debug-info">
      1758511800732 = <span id="converted-time"></span>
    </div>
  </div>

  <script>
    const debugOutput = document.getElementById('debug-output');
    const conversionResult = document.getElementById('converted-time');

    // è½¬æ¢æ—¶é—´æˆ³
    function convertTimestamp(ts) {
      const date = new Date(Number(ts));
      return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });
    }

    // æ˜¾ç¤ºè½¬æ¢ç»“æœ
    conversionResult.textContent = convertTimestamp('1758511800732');

    // æ·»åŠ è°ƒè¯•ä¿¡æ¯
    function addDebug(message, isError = false) {
      const timestamp = new Date().toLocaleTimeString();
      const className = isError ? 'error' : 'success';
      debugOutput.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      debugOutput.scrollTop = debugOutput.scrollHeight;
    }

    // æ¸…é™¤è°ƒè¯•ä¿¡æ¯
    function clearDebug() {
      debugOutput.innerHTML = 'è°ƒè¯•ä¿¡æ¯å·²æ¸…é™¤<br>';
    }

    // æ£€æŸ¥æ‰©å±•æ˜¯å¦åŠ è½½
    function testExtensionLoaded() {
      addDebug('å¼€å§‹æ£€æŸ¥æ‰©å±•...');
      
      // æ£€æŸ¥æ˜¯å¦æœ‰åŒå‡»ç›‘å¬å™¨
      const hasListener = getEventListeners && getEventListeners(document).dblclick;
      if (hasListener) {
        addDebug(`âœ“ æ£€æµ‹åˆ° ${hasListener.length} ä¸ªåŒå‡»äº‹ä»¶ç›‘å¬å™¨`);
      } else {
        addDebug('âœ— æ— æ³•æ£€æµ‹äº‹ä»¶ç›‘å¬å™¨ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼ŒgetEventListeners åªåœ¨å¼€å‘è€…å·¥å…·ä¸­å¯ç”¨ï¼‰');
      }

      // æ£€æŸ¥æ˜¯å¦æœ‰æ‰©å±•æ³¨å…¥çš„å…ƒç´ 
      const tooltip = document.getElementById('timestamp-tooltip');
      if (tooltip) {
        addDebug('âœ“ å‘ç°æ‰©å±•æ³¨å…¥çš„æç¤ºæ¡†å…ƒç´ ');
      } else {
        addDebug('âœ— æœªå‘ç°æç¤ºæ¡†å…ƒç´ ï¼ˆå¯èƒ½æ‰©å±•æœªåŠ è½½ï¼‰', true);
      }
    }

    // æµ‹è¯•å…ƒç´ æ–‡æœ¬æå–
    function testElementText() {
      addDebug('å¼€å§‹æµ‹è¯•å…ƒç´ æ–‡æœ¬æå–...');
      
      const element = document.querySelector('.dbsv5-table-cell div');
      if (!element) {
        addDebug('âœ— æ‰¾ä¸åˆ°æµ‹è¯•å…ƒç´ ', true);
        return;
      }

      addDebug(`âœ“ æ‰¾åˆ°å…ƒç´ : ${element.tagName}`);
      addDebug(`âœ“ textContent: "${element.textContent}"`);
      addDebug(`âœ“ innerText: "${element.innerText}"`);
      
      const match = element.textContent.match(/\b(\d{13})\b/);
      if (match) {
        addDebug(`âœ“ æ­£åˆ™åŒ¹é…æˆåŠŸ: ${match[1]}`);
        addDebug(`âœ“ è½¬æ¢ç»“æœ: ${convertTimestamp(match[1])}`);
      } else {
        addDebug('âœ— æ­£åˆ™åŒ¹é…å¤±è´¥', true);
      }
    }

    // æµ‹è¯•æ–‡æœ¬é€‰æ‹©
    function testSelection() {
      addDebug('è¯·å…ˆåŒå‡»æ—¶é—´æˆ³ï¼Œç„¶åç‚¹å‡»æ­¤æŒ‰é’®...');
      
      setTimeout(() => {
        const selection = window.getSelection();
        if (selection && selection.toString()) {
          addDebug(`âœ“ é€‰ä¸­çš„æ–‡æœ¬: "${selection.toString()}"`);
          addDebug(`âœ“ é€‰ä¸­çš„æ–‡æœ¬é•¿åº¦: ${selection.toString().length}`);
          
          const text = selection.toString().trim();
          if (/^\d{13}$/.test(text)) {
            addDebug('âœ“ é€‰ä¸­çš„æ˜¯æœ‰æ•ˆçš„13ä½æ—¶é—´æˆ³');
            addDebug(`âœ“ è½¬æ¢ç»“æœ: ${convertTimestamp(text)}`);
          } else {
            addDebug('âœ— é€‰ä¸­çš„æ–‡æœ¬ä¸æ˜¯æœ‰æ•ˆçš„13ä½æ—¶é—´æˆ³', true);
          }
        } else {
          addDebug('âœ— æ²¡æœ‰é€‰ä¸­ä»»ä½•æ–‡æœ¬', true);
        }
      }, 100);
    }

    // ç›‘å¬åŒå‡»äº‹ä»¶è¿›è¡Œè°ƒè¯•
    document.addEventListener('dblclick', function(event) {
      addDebug('--- æ£€æµ‹åˆ°åŒå‡»äº‹ä»¶ ---');
      addDebug(`åŒå‡»çš„å…ƒç´ : ${event.target.tagName}.${event.target.className || '(æ— ç±»å)'}`);
      addDebug(`å…ƒç´ æ–‡æœ¬: "${event.target.textContent?.trim()}"`);
      
      // å»¶è¿Ÿè·å–é€‰æ‹©
      setTimeout(() => {
        const selection = window.getSelection();
        if (selection && selection.toString()) {
          addDebug(`åŒå‡»åé€‰ä¸­: "${selection.toString()}"`);
        } else {
          addDebug('åŒå‡»åæœªé€‰ä¸­ä»»ä½•æ–‡æœ¬', true);
        }
      }, 50);
    }, true);

    // ç›‘å¬æ‰©å±•çš„æç¤ºæ¡†æ˜¾ç¤º
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        mutation.addedNodes.forEach(function(node) {
          if (node.id === 'timestamp-tooltip') {
            addDebug('âœ“ æ‰©å±•æç¤ºæ¡†å·²æ˜¾ç¤ºï¼');
          }
        });
      });
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true
    });

    addDebug('è°ƒè¯•å·¥å…·å·²å‡†å¤‡å°±ç»ª');
  </script>
</body>
</html>
